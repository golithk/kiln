name: Slack Release Notification (Multi-Target)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Existing release tag to test with (e.g. v2026.2.8)'
        required: true
        default: 'v2026.2.8'

permissions: {}

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch release info (manual trigger only)
        if: github.event_name == 'workflow_dispatch'
        id: release_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE=$(gh api repos/${{ github.repository }}/releases/tags/${{ inputs.release_tag }})
          echo "tag=$(echo "$RELEASE" | jq -r .tag_name)" >> "$GITHUB_OUTPUT"
          echo "url=$(echo "$RELEASE" | jq -r .html_url)" >> "$GITHUB_OUTPUT"
          # Body can be multiline, use a delimiter
          {
            echo "body<<BODY_EOF"
            echo "$RELEASE" | jq -r '.body // ""'
            echo "BODY_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send Slack notifications
        env:
          WEBHOOK_1: ${{ secrets.SLACK_WEBHOOK_URL_1 }}
          WEBHOOK_2: ${{ secrets.SLACK_WEBHOOK_URL_2 }}
          RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && steps.release_info.outputs.tag || github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event_name == 'workflow_dispatch' && steps.release_info.outputs.url || github.event.release.html_url }}
          RELEASE_BODY: ${{ github.event_name == 'workflow_dispatch' && steps.release_info.outputs.body || github.event.release.body }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          REPO_URL="https://github.com/${GITHUB_REPO}"

          # Convert markdown to Slack mrkdwn format
          convert_to_mrkdwn() {
            local text="$1"
            # Strip "What's Changed" section and everything after it
            text=$(echo "$text" | sed '/^## What'\''s Changed/,$d')
            # Remove trailing blank lines
            text=$(echo "$text" | sed -e :a -e '/^[[:space:]]*$/{ $d; N; ba; }')
            # Convert [text](url) to <url|text>
            text=$(echo "$text" | sed -E 's/\[([^]]+)\]\(([^)]+)\)/<\2|\1>/g')
            # Convert ## headers to bold
            text=$(echo "$text" | sed -E 's/^## (.+)/*\1*/')
            # Convert **bold** to *bold*
            text=$(echo "$text" | sed -E 's/\*\*([^*]+)\*\*/\*\1\*/g')
            # Link @usernames to GitHub profiles (skip if already inside a Slack link)
            text=$(echo "$text" | sed -E 's/(^|[^|<])@([a-zA-Z0-9_-]+)/\1<https:\/\/github.com\/\2|@\2>/g')
            # Link #issue references to GitHub issues (skip if inside URLs or Slack links)
            text=$(echo "$text" | sed -E 's/(^|[^|<\/])#([0-9]+)/\1<'"${REPO_URL//\//\\/}"'\/issues\/\2|#\2>/g')
            echo "$text"
          }

          # Prepare release notes
          if [ -n "$RELEASE_BODY" ]; then
            FORMATTED_BODY=$(convert_to_mrkdwn "$RELEASE_BODY")
            MESSAGE="ðŸš€ *Kiln ${RELEASE_TAG}* has been released!\n\n${FORMATTED_BODY}\n\n<${RELEASE_URL}|View Release on GitHub>"
          else
            MESSAGE="ðŸš€ *Kiln ${RELEASE_TAG}* has been released!\n\n<${RELEASE_URL}|View Release on GitHub>"
          fi

          # Escape JSON special characters
          MESSAGE=$(echo "$MESSAGE" | jq -Rs .)

          # Loop through webhook secrets and send to each
          webhook_sent=0
          for i in {1..2}; do
            webhook_var="WEBHOOK_${i}"
            webhook_url="${!webhook_var}"

            if [ -n "$webhook_url" ]; then
              echo "Sending notification to webhook $i..."
              curl -sf -X POST "$webhook_url" \
                -H 'Content-type: application/json' \
                --data "{\"text\": ${MESSAGE}}" || echo "Warning: Failed to send to webhook $i"
              webhook_sent=$((webhook_sent + 1))
            fi
          done

          if [ $webhook_sent -eq 0 ]; then
            echo "No webhook URLs configured (set SLACK_WEBHOOK_URL_1, SLACK_WEBHOOK_URL_2)"
          else
            echo "Sent notifications to $webhook_sent webhook(s)"
          fi
